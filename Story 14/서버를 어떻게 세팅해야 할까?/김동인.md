# Overview

- 설정에 대한 튜닝은 반드시 해야한다. 기본값으로 최대한의 성능을 낼 수 있는 것은 없다.

# 설정해야 하는 대상

- 서버 셋팅의 성능 테스트를 통해서 병목지점을 미리 파악해야한다.
- 애플리케이션 위주로 병목을 찾는 것 보다 세팅값을 먼저 진단하는 것이 효율적이다.

웹 기반 시스템 성능에 영향을 줄만한 세팅

- 웹 서버 세팅
- WAS 서버 세팅
- DB 서버 세팅
- 장비 세팅

# 아파치 웹 서버의 설정

- WAS를 웹 서버로 사용하면 안된다.
    - 웹 서버는 반드시 WAS 앞에 두어야 한다.
    - WAS는 Web Application Server이기 때문이다.
    - 그렇지 않으면 WAS 서버에서 웹 서버의 역할까지 수행해야 한다. 웹 서버를 WAS 서버 앞에 두지 않으면 이미지, CSS, 자바스크립트, HTML 등을 처리하느라 WAS 서버의 스레드를 점유하게 된다.
- 아파치 웹 서버는 MPM(Multi-Proccessing Module)을 사용한다. 이것은 여러 개의 프로세싱 모듈 기반의 서비스를 제공한다는 의미이다.
    - 아파치 설치 폴더 하단의 conf 디렉터리에 있는 httpd.conf를 수정해야한다.
        - ThreadsPerChild는 웹 서버가 사용하는 스레드의 개수를 지정한다.
        - StartServers
            - 서버를 띄울 때 프로세스의 개수를 지정한다. 보통 이야기하는 child 프로세스의 개수를 이야기한다.
        - MaxClients
            - 최대 처리 가능한 클라이언트의 수를 지정한다.
        - MinSpareThreads
            - 최소 여유 스레드 수를 지정한다
        - MaxSpareThreads
            - 최대 여유 스레드 수를 지정한다.
        - ThreadsPerChild
            - 프로세스당 스레드 수를 지정한다
        - MaxRequestsPerCHild
            - 앞서 이야기한 MaxRequestsPerChild와 같은 의미이다.
- GC가 동작해서 쓰레드를 사용하게 되면 WAS가 응답하지 않을 때 요청을 큐에 담아둔다. 최대를 넘어서면 503(Service Unavailable)이라는 HTTP 헤더 코드 값을 리턴한다.
    - 503를 줄이기 위해서는 다음과 같은 조치를 할 수 있다.
        1. 서버를 늘린다
            1. 어떻게 보면 가장 편한 방법이다. 금전적인 여유가 있을 때이다.
        2. 서비스를 튜닝한다
            1. 서비스가 응답이 안되는 원인을 찾고 튜닝한다. 하지만 말이 쉽지 실제로 그 원인을 찾고 튜닝한다. 하지만 말이 쉽지 실제로 그 원인을 찾는 데는 몇시간이 소요될 수 있으며 몇 달이 걸릴 수 있다.
        3. GC 튜닝을 한다
            1. 만약 GC가 오래 소요되어 응답이 안될 경우 GC 튜닝을 한다.
        4. 각종 옵션 값을 튜닝한다
            1. 잘 못 설정할 경우 더 큰 문제가 야기가 될 수 있기 때문에 해당 웹 서버 및 WAS의 전문가나 엔지니어와 같이 이야기해서 옵션 값을 설정하기 바란다.

# 웹 서버의 Keep Alive


- 웹 서버와 웹 브라우저가 연결이 되었을 때 KeepAlive 기능이 켜져 있지 않으면 매번 HTTP 연결을 맺었다 끊었다 하는 작업을 반복한다.

> 사용자의 접근이 많은 사이트에서는 이미지나 CSS와 같이 정적인 파일을 일반적인 웹서버에서 처리하지 않고 CDN(Content Delivery Network)라는 서비스를 사용한다. 별도의 URL 에서 해당 컨텐츠들을 내려받도록 설정하고 동적인 컨텐츠들은 WAS에서 처리하도록 해 놓으면 Web-WAS 서버의 부담도 줄어들게 된다.

- 이미지와 모든 개체들도 서버에 매번 접속을 해야하는 상황이 발생한다
- KeepAlive 기능이 커져있으면 두 개정도의 연결을 열어서 끊지 않고 연결을 계속 재사용한다.
- 사용자가 느끼는 응답속도도 빨라진다.
- KeepAlive-TimeOut 설정도 알아야 한다. 초 단위로 KeepAlive 끊기는 설정하기 위한 부분이다. 마지막 연결이 끝난 이후에 연결이 될 때까지 얼마나 기다릴지 지정한다.
    - 사용자가 너무 많아 접속이 잘 안될 경우 5초 정도로 짧게주는 것도 서버의 리소스를 보다 효율적으로 사용할 수 있는 방법이다.

# DB Connection Pool 및 스레드 개수 설정

- DB Connection Pool과 스레드 개수는 메모리와 관련이 있다. 많이 사용할수록 메모리를 많이 점유하게 된다.
- 메모리를 위해서 DB Connection Pool과 스레드 개수를 적게 지정하면 서버에서 많은 요청을 처리하지 못하고 대기할 수 있다.
- 운영중에 최소 및 최대값을 동일하게 하는 것이 좋다. 대부분 WAS에서 두 설정 값의 기본 개수가 10~20개이다.
- DB Connection Pool은 보통 40~50개로 지정하며 스레드 개수는 이보다 10개정도 더 지정한다.
    - 스레드는 입구이고 DB Connection Pool은 출구라고 생각하자.
- DB Connection Pool의 개수를 넘어섰을 때 대기시간을 사용하는데 이 시간을 짧게 줘야한다.
    - 그렇다고 너무 짧게 주면(약 100ms) Full GC시간을 만들기가 어렵다.  Full GC인 경우 대기하고 있는 모든 스레드가 DB와 연결 못하고 Timeout을 발생시킬 수 있다.
- Pool의 개수, Wait과 관련된 값이 들어간 값 Timeout 관련된 설정들을 시스템의 상황에 맞게 설정해야 한다.

# WAS 인스턴스 개수 설정

---

- 서버의 WAS 인스턴스 개수를 늘리면 늘릴수록 CPU가 처리해야하는 양이 많아진다.
- 보통 1~2개의 CPU당 하나의 인스턴스를 지정하는 것이 좋다. 또는 스트레스 테스트를 통해서 구하는 것이 바람직하다.
- 인스턴스를 늘린다고해서 TPS가 증가하지 않으면 유지보수성만 떨어진다. 배포나 모니터링에 문제가 생긴다.

# Session Timeout 시간 설정

---

- 세션 종료 설정을 적절하게 해놔야한다.
